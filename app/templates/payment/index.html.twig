{% extends 'base.html.twig' %}



{% block title %}Paiement{% endblock %}

{% block body %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="mb-0">Paiement de votre réservation</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h5>Récapitulatif</h5>
                            <p><strong>Du :</strong> {{ reservation.date_debut }}</p>
                            <p><strong>Au :</strong> {{ reservation.date_fin }}</p>
                            <p class="h4"><strong>Total :</strong> {{ reservation.total|number_format(2, ',', ' ') }} €</p>
                        </div>

                        <form id="payment-form">
                            <div class="mb-3">
                                <label class="form-label">Informations de carte bancaire</label>
                                <div id="card-element" class="form-control" style="height: 40px; padding-top: 10px;">
                                    <!-- Stripe Card Element will be inserted here -->
                                </div>
                                <div id="card-errors" class="text-danger mt-2" role="alert"></div>
                            </div>

                            <button id="submit-button" class="btn btn-warning w-100" type="submit">
                                <span id="button-text">Payer {{ reservation.total|number_format(2, ',', ' ') }} €</span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </form>

                        <div class="mt-3 text-center">
                            <a href="{{ path('app_payment_cancel') }}" class="text-muted">Annuler</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('{{ stripe_public_key }}');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        cardElement.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');

            try {
                const response = await fetch('{{ path('app_payment_create_intent') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
                    payment_method: {
                        card: cardElement,
                    }
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    submitButton.disabled = false;
                    buttonText.classList.remove('d-none');
                    spinner.classList.add('d-none');
                } else if (paymentIntent.status === 'succeeded') {
                    window.location.href = '{{ path('app_payment_confirm') }}';
                }
            } catch (error) {
                document.getElementById('card-errors').textContent = error.message;
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        });
    </script>
{% endblock %}
